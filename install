#!/bin/bash
# ðŸš€ Memory Bank Agent Installer v3
# Run from ANY project directory: ~/memory-bank-agent/install [--cursor|--claude|--all]
# Copies .cursor/ and/or .claude/ folders + CLAUDE.md (for Claude Code)

set -e

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get the script's directory (where memory-bank-agent is installed)
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# Target is current working directory
TARGET_DIR="$(pwd)"

# Default: install .cursor only
INSTALL_CURSOR=true
INSTALL_CLAUDE=false

# Parse arguments
if [ "$1" = "--claude" ]; then
  INSTALL_CURSOR=false
  INSTALL_CLAUDE=true
elif [ "$1" = "--all" ]; then
  INSTALL_CURSOR=true
  INSTALL_CLAUDE=true
elif [ "$1" = "--cursor" ] || [ -z "$1" ]; then
  INSTALL_CURSOR=true
  INSTALL_CLAUDE=false
else
  echo "Usage: ~/memory-bank-agent/install [--cursor|--claude|--all]"
  echo ""
  echo "Options:"
  echo "  --cursor  Copy .cursor/ folder only (default)"
  echo "  --claude  Copy .claude/ folder only"
  echo "  --all     Copy both .cursor/ and .claude/ folders"
  exit 1
fi

echo -e "${BLUE}ðŸš€ Memory Bank Agent Installer${NC}"
echo -e "   Source: ${SCRIPT_DIR}"
echo -e "   Target: ${TARGET_DIR}"
echo ""

# Check if we're in the memory-bank-agent directory itself
if [ "$TARGET_DIR" = "$SCRIPT_DIR" ]; then
  echo -e "${YELLOW}âš ï¸  You're running install from the memory-bank-agent directory itself!${NC}"
  echo "   Please run this from your project directory:"
  echo "   cd /path/to/your/project"
  echo "   ~/memory-bank-agent/install"
  exit 1
fi

# Install .cursor/
if [ "$INSTALL_CURSOR" = true ]; then
  echo -e "${GREEN}ðŸ“ Installing .cursor/ folder...${NC}"
  if [ -d "$TARGET_DIR/.cursor" ]; then
    echo "   âš ï¸  .cursor/ already exists, merging safely..."
    
    # Copy commands if they don't exist
    if [ -d "$SCRIPT_DIR/.cursor/commands" ]; then
      mkdir -p "$TARGET_DIR/.cursor/commands"
      cp -rn "$SCRIPT_DIR/.cursor/commands/"* "$TARGET_DIR/.cursor/commands/" 2>/dev/null || true
      echo "   âœ… Commands merged"
    fi
    
    # Copy rules if they don't exist
    if [ -d "$SCRIPT_DIR/.cursor/rules" ]; then
      mkdir -p "$TARGET_DIR/.cursor/rules"
      cp -n "$SCRIPT_DIR/.cursor/rules/"* "$TARGET_DIR/.cursor/rules/" 2>/dev/null || true
      echo "   âœ… Rules merged"
    fi
  else
    cp -r "$SCRIPT_DIR/.cursor" "$TARGET_DIR/"
    echo "   âœ… .cursor/ copied"
  fi
fi

# Install .claude/ and CLAUDE.md
if [ "$INSTALL_CLAUDE" = true ]; then
  echo -e "${GREEN}â˜ï¸  Installing .claude/ folder...${NC}"
  if [ -d "$SCRIPT_DIR/.claude" ]; then
    if [ -d "$TARGET_DIR/.claude" ]; then
      echo "   âš ï¸  .claude/ already exists, merging safely..."
      mkdir -p "$TARGET_DIR/.claude/commands"
      cp -rn "$SCRIPT_DIR/.claude/commands/"* "$TARGET_DIR/.claude/commands/" 2>/dev/null || true
      echo "   âœ… Commands merged"
    else
      cp -r "$SCRIPT_DIR/.claude" "$TARGET_DIR/"
      echo "   âœ… .claude/ copied"
    fi
  else
    echo "   âš ï¸  No .claude/ folder found in memory-bank-agent"
  fi
  
  # Copy CLAUDE.md (required for Claude Code to load project context)
  echo -e "${GREEN}ðŸ“„ Installing CLAUDE.md...${NC}"
  if [ -f "$SCRIPT_DIR/CLAUDE.md" ]; then
    if [ -f "$TARGET_DIR/CLAUDE.md" ]; then
      echo "   âš ï¸  CLAUDE.md already exists, skipping (to preserve your customizations)"
      echo "   ðŸ’¡ If you want to update it, manually copy from: $SCRIPT_DIR/CLAUDE.md"
    else
      cp "$SCRIPT_DIR/CLAUDE.md" "$TARGET_DIR/"
      echo "   âœ… CLAUDE.md copied"
    fi
  else
    echo "   âš ï¸  No CLAUDE.md found in memory-bank-agent"
  fi
fi

echo ""
echo -e "${GREEN}ðŸŽ‰ Installation Complete!${NC}"
echo ""
if [ "$INSTALL_CURSOR" = true ]; then
  echo "Next steps for Cursor:"
  echo "1. Restart Cursor (Cmd/Ctrl + Shift + P > 'Developer: Reload Window')"
  echo "2. Run: mb/init (this command is used to initialize the memory bank system)"
  echo "3. Run: mb/include (this command is used to ACTIVATE the memory bank system on sessions you see fit)"
  echo "4. Generate docs: mb/shape-project-brief, mb/shape-system-patterns, etc."
fi
if [ "$INSTALL_CLAUDE" = true ]; then
  echo "Next steps for Claude Code:"
  echo "1. Restart Claude Code (or open this project)"
  echo "2. CLAUDE.md is now in your project root - Claude will automatically load it"
  echo "3. Run: mb/init (this command is used to initialize the memory bank system)"
  echo "4. Run: mb/include (this command is used to ACTIVATE the memory bank system on sessions you see fit)"
  echo "5. Generate docs: mb/shape-project-brief, mb/shape-system-patterns, etc."
fi
echo ""
echo -e "${BLUE}Happy coding! ðŸš€${NC}"