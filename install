#!/bin/bash
# ðŸš€ Memory Bank Agent Installer v3
# Run from ANY project directory: ~/memory-bank-agent/install [--cursor|--claude|--all] [--overwrite|--no-overwrite]
# Copies .cursor/ and/or .claude/ folders + CLAUDE.md (for Claude Code)

set -e

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get the script's directory (where memory-bank-agent is installed)
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# Target is current working directory
TARGET_DIR="$(pwd)"

# Default: install .cursor only
INSTALL_CURSOR=true
INSTALL_CLAUDE=false

# Overwrite behavior:
# - "prompt": ask before overwriting Memory Bank setup inside existing .cursor/
# - "yes": always overwrite
# - "no": never overwrite (merge safely)
OVERWRITE_MODE="prompt"

print_usage() {
  echo "Usage: ~/memory-bank-agent/install [--cursor|--claude|--all] [--overwrite|--no-overwrite]"
  echo ""
  echo "Options:"
  echo "  --cursor         Copy .cursor/ folder only (default)"
  echo "  --claude         Copy .claude/ folder only"
  echo "  --all            Copy both .cursor/ and .claude/ folders"
  echo "  --overwrite      Overwrite Memory Bank commands/rules/templates in existing .cursor/"
  echo "  --no-overwrite   Never overwrite, merge safely (skip existing files)"
  echo "  --help           Show this help"
}

# Parse args (order-independent)
for arg in "$@"; do
  case "$arg" in
    --cursor)
      INSTALL_CURSOR=true
      INSTALL_CLAUDE=false
      ;;
    --claude)
      INSTALL_CURSOR=false
      INSTALL_CLAUDE=true
      ;;
    --all)
      INSTALL_CURSOR=true
      INSTALL_CLAUDE=true
      ;;
    --overwrite|--force)
      OVERWRITE_MODE="yes"
      ;;
    --no-overwrite)
      OVERWRITE_MODE="no"
      ;;
    --help|-h)
      print_usage
      exit 0
      ;;
    "")
      ;;
    *)
      print_usage
      exit 1
      ;;
  esac
done

echo -e "${BLUE}ðŸš€ Memory Bank Agent Installer${NC}"
echo -e "   Source: ${SCRIPT_DIR}"
echo -e "   Target: ${TARGET_DIR}"
echo ""

# Check if we're in the memory-bank-agent directory itself
if [ "$TARGET_DIR" = "$SCRIPT_DIR" ]; then
  echo -e "${YELLOW}âš ï¸  You're running install from the memory-bank-agent directory itself!${NC}"
  echo "   Please run this from your project directory:"
  echo "   cd /path/to/your/project"
  echo "   ~/memory-bank-agent/install"
  exit 1
fi

# Install .cursor/
if [ "$INSTALL_CURSOR" = true ]; then
  echo -e "${GREEN}ðŸ“ Installing .cursor/ folder...${NC}"
  if [ -d "$TARGET_DIR/.cursor" ]; then
    OVERWRITE=false
    if [ "$OVERWRITE_MODE" = "yes" ]; then
      OVERWRITE=true
    elif [ "$OVERWRITE_MODE" = "no" ]; then
      OVERWRITE=false
    else
      echo -e "   ${YELLOW}âš ï¸  .cursor/ already exists.${NC}"
      echo "   This project may already have Memory Bank setup."
      echo "   Overwrite Memory Bank setup with the latest version?"
      echo "   (Overwrites ONLY: .cursor/commands/mb, .cursor/rules, .cursor/templates)"
      echo "   (Does NOT touch: your project's memory-bank/ docs)"
      read -r -p "   Overwrite? (y/N): " OVERWRITE_ANSWER
      if [[ "$OVERWRITE_ANSWER" =~ ^[Yy]$ ]]; then
        OVERWRITE=true
      fi
    fi

    if [ "$OVERWRITE" = true ]; then
      echo "   âœ… Overwriting Memory Bank commands/rules/templates..."

      # Overwrite commands (Memory Bank only)
      if [ -d "$SCRIPT_DIR/.cursor/commands/mb" ]; then
        mkdir -p "$TARGET_DIR/.cursor/commands/mb"
        cp -R "$SCRIPT_DIR/.cursor/commands/mb/"* "$TARGET_DIR/.cursor/commands/mb/" 2>/dev/null || true
        echo "   âœ… Commands overwritten (.cursor/commands/mb)"
      fi

      # Overwrite rules
      if [ -d "$SCRIPT_DIR/.cursor/rules" ]; then
        mkdir -p "$TARGET_DIR/.cursor/rules"
        cp -R "$SCRIPT_DIR/.cursor/rules/"* "$TARGET_DIR/.cursor/rules/" 2>/dev/null || true
        echo "   âœ… Rules overwritten"
      fi

      # Overwrite templates
      if [ -d "$SCRIPT_DIR/.cursor/templates" ]; then
        mkdir -p "$TARGET_DIR/.cursor/templates"
        cp -R "$SCRIPT_DIR/.cursor/templates/"* "$TARGET_DIR/.cursor/templates/" 2>/dev/null || true
        echo "   âœ… Templates overwritten"
      fi
    else
      echo "   âš ï¸  .cursor/ already exists, merging safely..."
    
      # Copy commands if they don't exist
      if [ -d "$SCRIPT_DIR/.cursor/commands" ]; then
        mkdir -p "$TARGET_DIR/.cursor/commands"
        cp -rn "$SCRIPT_DIR/.cursor/commands/"* "$TARGET_DIR/.cursor/commands/" 2>/dev/null || true
        echo "   âœ… Commands merged"
      fi
    
      # Copy rules if they don't exist
      if [ -d "$SCRIPT_DIR/.cursor/rules" ]; then
        mkdir -p "$TARGET_DIR/.cursor/rules"
        cp -n "$SCRIPT_DIR/.cursor/rules/"* "$TARGET_DIR/.cursor/rules/" 2>/dev/null || true
        echo "   âœ… Rules merged"
      fi
    
      # Copy templates if they don't exist
      if [ -d "$SCRIPT_DIR/.cursor/templates" ]; then
        mkdir -p "$TARGET_DIR/.cursor/templates"
        cp -rn "$SCRIPT_DIR/.cursor/templates/"* "$TARGET_DIR/.cursor/templates/" 2>/dev/null || true
        echo "   âœ… Templates merged"
      fi
    fi
  else
    cp -r "$SCRIPT_DIR/.cursor" "$TARGET_DIR/"
    echo "   âœ… .cursor/ copied"
  fi
fi

# Install .claude/ and CLAUDE.md
if [ "$INSTALL_CLAUDE" = true ]; then
  echo -e "${GREEN}â˜ï¸  Installing .claude/ folder...${NC}"
  if [ -d "$SCRIPT_DIR/.claude" ]; then
    if [ -d "$TARGET_DIR/.claude" ]; then
      echo "   âš ï¸  .claude/ already exists, merging safely..."
      mkdir -p "$TARGET_DIR/.claude/commands"
      cp -rn "$SCRIPT_DIR/.claude/commands/"* "$TARGET_DIR/.claude/commands/" 2>/dev/null || true
      echo "   âœ… Commands merged"
    else
      cp -r "$SCRIPT_DIR/.claude" "$TARGET_DIR/"
      echo "   âœ… .claude/ copied"
    fi
  else
    echo "   âš ï¸  No .claude/ folder found in memory-bank-agent"
  fi
  
  # Copy CLAUDE.md (required for Claude Code to load project context)
  echo -e "${GREEN}ðŸ“„ Installing CLAUDE.md...${NC}"
  if [ -f "$SCRIPT_DIR/CLAUDE.md" ]; then
    if [ -f "$TARGET_DIR/CLAUDE.md" ]; then
      echo "   âš ï¸  CLAUDE.md already exists, skipping (to preserve your customizations)"
      echo "   ðŸ’¡ If you want to update it, manually copy from: $SCRIPT_DIR/CLAUDE.md"
    else
      cp "$SCRIPT_DIR/CLAUDE.md" "$TARGET_DIR/"
      echo "   âœ… CLAUDE.md copied"
    fi
  else
    echo "   âš ï¸  No CLAUDE.md found in memory-bank-agent"
  fi
fi

echo ""
echo -e "${GREEN}ðŸŽ‰ Installation Complete!${NC}"
echo ""
if [ "$INSTALL_CURSOR" = true ]; then
  echo "Next steps for Cursor:"
  echo "1. Restart Cursor (Cmd/Ctrl + Shift + P > 'Developer: Reload Window')"
  echo "2. Run: mb/init (this command is used to initialize the memory bank system)"
  echo "3. Run: mb/include (this command is used to ACTIVATE the memory bank system on sessions you see fit)"
  echo "4. Generate docs: mb/shape-project-brief, mb/shape-system-patterns, etc."
fi
if [ "$INSTALL_CLAUDE" = true ]; then
  echo "Next steps for Claude Code:"
  echo "1. Restart Claude Code (or open this project)"
  echo "2. CLAUDE.md is now in your project root - Claude will automatically load it"
  echo "3. Run: mb/init (this command is used to initialize the memory bank system)"
  echo "4. Run: mb/include (this command is used to ACTIVATE the memory bank system on sessions you see fit)"
  echo "5. Generate docs: mb/shape-project-brief, mb/shape-system-patterns, etc."
fi
echo ""
echo -e "${BLUE}Happy coding! ðŸš€${NC}"